<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDF+</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1. PDF-LIB (Core PDF Logic) -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
    <!-- 2. FileSaver (Downloads) -->
    <script src="https://unpkg.com/downloadjs@1.4.7/download.min.js"></script>
    
    <!-- 3. JSZip (Utilities) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- 4. PDF.js (Reading Text for Notebook) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Handwriting Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Caveat:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        // Configure PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 - Clean Flat */
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Modern Loader */
        .loader {
            width: 48px;
            height: 48px;
            border: 4px solid #e2e8f0;
            border-bottom-color: #ef4444; /* Red Brand Color */
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* App Screen Transitions */
        .screen { display: none; animation: fadeIn 0.3s ease-out; }
        .screen.active { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Button Press Effect */
        .btn-press:active { transform: scale(0.96); opacity: 0.9; transition: transform 0.1s; }
        
        /* Notebook Preview Canvas (Hidden) */
        #notebookCanvas { display: none; }
    </style>
</head>
<body class="h-screen w-full overflow-hidden flex flex-col relative bg-slate-50">

    <!-- App Header -->
    <header class="bg-white/95 backdrop-blur-sm shadow-sm z-20 flex-none h-16 flex items-center justify-between px-5 border-b border-gray-100 sticky top-0">
        <div class="flex items-center gap-3" onclick="showHome()">
            <!-- Native App Icon Style -->
            <div class="w-9 h-9 bg-red-500 rounded-xl flex items-center justify-center text-white font-bold shadow-md shadow-red-200">
                <i data-lucide="file-text" class="w-5 h-5 text-white"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800 tracking-tight">PDF+</h1>
        </div>
        <button id="headerBackBtn" class="hidden p-2 rounded-full hover:bg-gray-100 btn-press text-gray-600 transition-colors" onclick="showHome()">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto no-scrollbar relative w-full max-w-lg mx-auto bg-white sm:shadow-2xl sm:my-6 sm:rounded-2xl sm:h-[calc(100vh-3rem)] sm:border border-gray-100">
        
        <!-- DASHBOARD (Home) -->
        <div id="screen-home" class="screen active flex-col p-6 min-h-full bg-white">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Tools</h2>
                <p class="text-gray-400 text-sm mt-1">Select an action to process your files.</p>
            </div>

            <!-- Tools Grid -->
            <div class="grid grid-cols-2 gap-4 pb-12">
                <!-- 1. Notebook (Featured) -->
                <div onclick="openTool('notebook')" class="col-span-2 bg-yellow-50 p-5 rounded-2xl flex items-center justify-between gap-4 cursor-pointer btn-press border border-yellow-100 hover:border-yellow-200 shadow-sm relative overflow-hidden group">
                    <div class="flex flex-col gap-1 z-10">
                        <span class="font-bold text-yellow-900 text-lg">PDF to Notebook</span>
                        <span class="text-yellow-700 text-xs">Convert text to handwriting ‚úçÔ∏è</span>
                    </div>
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-yellow-500 shadow-sm z-10">
                        <i data-lucide="pen-tool" class="w-6 h-6"></i>
                    </div>
                    <!-- Decorative BG -->
                    <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-yellow-100 rounded-full opacity-50 group-hover:scale-150 transition-transform duration-500"></div>
                </div>

                <!-- 2. Merge -->
                <div onclick="openTool('merge')" class="bg-red-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 cursor-pointer btn-press border border-red-100 hover:border-red-200 h-32">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-red-500">
                        <i data-lucide="files" class="w-5 h-5"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs">Merge</span>
                </div>

                <!-- 3. Split -->
                <div onclick="openTool('split')" class="bg-blue-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 cursor-pointer btn-press border border-blue-100 hover:border-blue-200 h-32">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-blue-500">
                        <i data-lucide="scissors" class="w-5 h-5"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs">Split</span>
                </div>

                <!-- 4. PDF to Image -->
                <div onclick="openTool('pdf2img')" class="bg-orange-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 cursor-pointer btn-press border border-orange-100 hover:border-orange-200 h-32">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-orange-500">
                        <i data-lucide="image-down" class="w-5 h-5"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs">PDF to IMG</span>
                </div>

                <!-- 5. Image to PDF -->
                <div onclick="openTool('img2pdf')" class="bg-green-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 cursor-pointer btn-press border border-green-100 hover:border-green-200 h-32">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-green-500">
                        <i data-lucide="image-plus" class="w-5 h-5"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs">IMG to PDF</span>
                </div>

                <!-- 6. Protect -->
                <div onclick="openTool('protect')" class="bg-gray-100 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 cursor-pointer btn-press border border-gray-200 hover:border-gray-300 h-32">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-gray-600">
                        <i data-lucide="lock" class="w-5 h-5"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs">Protect</span>
                </div>

                <!-- 7. Collage/Grid -->
                <div onclick="openTool('grid')" class="bg-indigo-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 cursor-pointer btn-press border border-indigo-100 hover:border-indigo-200 h-32">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-indigo-500">
                        <i data-lucide="layout-grid" class="w-5 h-5"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs">Collage</span>
                </div>
            </div>
        </div>

        <!-- 1. NOTEBOOK TOOL (Main Feature) -->
        <div id="tool-notebook" class="screen flex-col h-full hidden bg-white">
            <div class="p-6 flex-1 flex flex-col gap-6">
                <div class="text-center">
                    <h3 class="text-xl font-bold text-gray-800">PDF to Notebook</h3>
                    <p class="text-xs text-gray-500">Extracts text & converts to handwriting.</p>
                </div>

                <div class="bg-yellow-50/50 border-2 border-dashed border-yellow-200 rounded-xl p-6 flex flex-col items-center justify-center relative hover:bg-yellow-50 transition h-32">
                    <input type="file" id="notebookInput" accept=".pdf" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="handleFileSelect('notebook')">
                    <i data-lucide="pen-line" class="w-8 h-8 text-yellow-600 mb-2"></i>
                    <p id="notebookFileName" class="text-sm font-medium text-gray-600 truncate max-w-[200px]">Select PDF</p>
                </div>

                <!-- Notebook Style Options -->
                <div id="notebookOptions" class="hidden flex-col gap-4">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Ink Style</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setInk('blue', this)" class="ink-opt active ring-2 ring-blue-500 p-2 bg-white border rounded-lg text-xs font-medium text-blue-600 flex items-center justify-center gap-1">
                            <div class="w-3 h-3 rounded-full bg-blue-600"></div> Blue
                        </button>
                        <button onclick="setInk('black', this)" class="ink-opt p-2 bg-white border rounded-lg text-xs font-medium text-gray-800 flex items-center justify-center gap-1">
                            <div class="w-3 h-3 rounded-full bg-gray-800"></div> Black
                        </button>
                        <button onclick="setInk('mixed', this)" class="ink-opt p-2 bg-white border rounded-lg text-xs font-medium text-purple-600 flex items-center justify-center gap-1">
                            <div class="w-3 h-3 rounded-full bg-gradient-to-r from-blue-500 to-red-500"></div> Mix
                        </button>
                    </div>
                </div>

                <div class="flex-1"></div>
                <button id="btn-notebook-action" onclick="processNotebook()" disabled class="w-full bg-yellow-500 text-white font-semibold py-4 rounded-xl shadow-lg shadow-yellow-200 btn-press disabled:opacity-50 disabled:cursor-not-allowed">
                    Convert to Notebook
                </button>
            </div>
        </div>

        <!-- 2. PROTECT TOOL (Fixed) -->
        <div id="tool-protect" class="screen flex-col h-full hidden bg-white">
            <div class="p-6 flex-1 flex flex-col gap-6">
                <div class="text-center">
                    <h3 class="text-xl font-bold text-gray-800">Protect PDF</h3>
                    <p class="text-xs text-gray-500">Secure with password.</p>
                </div>
                <div class="bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl p-6 flex flex-col items-center justify-center relative h-32">
                    <input type="file" id="protectInput" accept=".pdf" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="handleFileSelect('protect')">
                    <i data-lucide="shield-check" class="w-8 h-8 text-gray-400 mb-2"></i>
                    <p id="protectFileName" class="text-sm font-medium text-gray-600 truncate max-w-[200px]">Select PDF</p>
                </div>
                
                <div id="protectOptions" class="hidden flex-col gap-2">
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">Set Password</label>
                    <div class="relative">
                        <input type="password" id="pdfPassword" placeholder="Enter secure password" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-gray-500 transition-all">
                        <i data-lucide="key" class="w-4 h-4 text-gray-400 absolute right-3 top-3.5"></i>
                    </div>
                </div>

                <div class="flex-1"></div>
                <button id="btn-protect-action" onclick="processProtect()" disabled class="w-full bg-gray-800 text-white font-semibold py-4 rounded-xl shadow-lg shadow-gray-200 btn-press disabled:opacity-50">
                    Lock PDF
                </button>
            </div>
        </div>

        <!-- 3. MERGE TOOL -->
        <div id="tool-merge" class="screen flex-col h-full hidden bg-white">
            <div class="p-6 flex-1 flex flex-col gap-6">
                <div class="text-center">
                    <h3 class="text-xl font-bold text-gray-800">Merge PDF</h3>
                    <p class="text-xs text-gray-500">Combine multiple files.</p>
                </div>
                <div class="bg-red-50/50 border-2 border-dashed border-red-200 rounded-xl p-6 flex flex-col items-center justify-center relative hover:bg-red-50 transition h-32">
                    <input type="file" id="mergeInput" multiple accept=".pdf" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="handleFileSelect('merge')">
                    <i data-lucide="layers" class="w-8 h-8 text-red-400 mb-2"></i>
                    <p class="text-sm font-medium text-gray-600">Tap to select files</p>
                </div>
                <div id="mergeFileList" class="flex flex-col gap-2 overflow-y-auto max-h-48 hidden"></div>
                <div class="flex-1"></div>
                <button id="btn-merge-action" onclick="processMerge()" disabled class="w-full bg-red-500 text-white font-semibold py-4 rounded-xl shadow-lg shadow-red-200 btn-press disabled:opacity-50">Merge Files</button>
            </div>
        </div>

        <!-- 4. SPLIT TOOL -->
        <div id="tool-split" class="screen flex-col h-full hidden bg-white">
            <div class="p-6 flex-1 flex flex-col gap-6">
                <div class="text-center">
                    <h3 class="text-xl font-bold text-gray-800">Split PDF</h3>
                    <p class="text-xs text-gray-500">Extract pages.</p>
                </div>
                <div class="bg-blue-50/50 border-2 border-dashed border-blue-200 rounded-xl p-6 flex flex-col items-center justify-center relative h-32">
                    <input type="file" id="splitInput" accept=".pdf" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="handleFileSelect('split')">
                    <p id="splitFileName" class="text-sm font-medium text-blue-600 truncate max-w-[200px]">Select PDF</p>
                </div>
                <div id="splitOptions" class="hidden flex-col gap-2">
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">Page Numbers</label>
                    <input type="text" id="splitPages" placeholder="e.g. 1, 3, 5-8" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex-1"></div>
                <button id="btn-split-action" onclick="processSplit()" disabled class="w-full bg-blue-500 text-white font-semibold py-4 rounded-xl shadow-lg shadow-blue-200 btn-press disabled:opacity-50">Split PDF</button>
            </div>
        </div>

        <!-- 5. IMG TO PDF -->
        <div id="tool-img2pdf" class="screen flex-col h-full hidden bg-white">
            <div class="p-6 flex-1 flex flex-col gap-6">
                <div class="text-center">
                    <h3 class="text-xl font-bold text-gray-800">Images to PDF</h3>
                    <p class="text-xs text-gray-500">Photos to Document.</p>
                </div>
                <div class="bg-green-50/50 border-2 border-dashed border-green-200 rounded-xl p-6 flex flex-col items-center justify-center relative hover:bg-green-50 transition h-32">
                    <input type="file" id="img2pdfInput" multiple accept="image/png, image/jpeg, image/jpg" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="handleFileSelect('img2pdf')">
                    <i data-lucide="image-plus" class="w-8 h-8 text-green-500 mb-2"></i>
                    <p class="text-sm font-medium text-gray-600">Select Photos</p>
                </div>
                <div id="img2pdfList" class="flex flex-col gap-2 overflow-y-auto max-h-48 hidden"></div>
                <div class="flex-1"></div>
                <button id="btn-img2pdf-action" onclick="processImgToPdf()" disabled class="w-full bg-green-500 text-white font-semibold py-4 rounded-xl shadow-lg shadow-green-200 btn-press disabled:opacity-50">Create PDF</button>
            </div>
        </div>

        <!-- 6. PDF TO IMG -->
        <div id="tool-pdf2img" class="screen flex-col h-full hidden bg-white">
            <div class="p-6 flex-1 flex flex-col gap-6">
                <div class="text-center">
                    <h3 class="text-xl font-bold text-gray-800">PDF to Images</h3>
                    <p class="text-xs text-gray-500">Convert to HD Images (ZIP).</p>
                </div>
                <div class="bg-orange-50/50 border-2 border-dashed border-orange-200 rounded-xl p-6 flex flex-col items-center justify-center relative h-32">
                    <input type="file" id="pdf2imgInput" accept=".pdf" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="handleFileSelect('pdf2img')">
                    <p id="pdf2imgFileName" class="text-sm font-medium text-orange-600 truncate max-w-[200px]">Select PDF</p>
                </div>
                <div class="flex-1"></div>
                <button id="btn-pdf2img-action" onclick="processPdfToImg()" disabled class="w-full bg-orange-500 text-white font-semibold py-4 rounded-xl shadow-lg shadow-orange-200 btn-press disabled:opacity-50">Convert & Download</button>
            </div>
        </div>

        <!-- 7. COLLAGE -->
        <div id="tool-grid" class="screen flex-col h-full hidden bg-white">
            <div class="p-6 flex-1 flex flex-col gap-6">
                <div class="text-center">
                    <h3 class="text-xl font-bold text-gray-800">Grid Collage</h3>
                    <p class="text-xs text-gray-500">Fit 2 or 4 pages on one sheet.</p>
                </div>
                <div class="bg-indigo-50/50 border-2 border-dashed border-indigo-200 rounded-xl p-6 flex flex-col items-center justify-center relative h-32">
                    <input type="file" id="gridInput" accept=".pdf" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="handleFileSelect('grid')">
                    <p id="gridFileName" class="text-sm font-medium text-indigo-600 truncate max-w-[200px]">Select PDF</p>
                </div>
                <div id="gridOptions" class="hidden flex-col gap-3">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectGrid(2, this)" class="grid-opt p-3 border border-indigo-200 rounded-lg text-sm font-medium bg-indigo-50 text-indigo-700" data-val="2">2 Pages</button>
                        <button onclick="selectGrid(4, this)" class="grid-opt p-3 border border-gray-200 rounded-lg text-sm font-medium text-gray-600" data-val="4">4 Pages</button>
                    </div>
                </div>
                <div class="flex-1"></div>
                <button id="btn-grid-action" onclick="processGrid()" disabled class="w-full bg-indigo-500 text-white font-semibold py-4 rounded-xl shadow-lg shadow-indigo-200 btn-press disabled:opacity-50">Create Collage</button>
            </div>
        </div>

    </main>

    <!-- Overlay Loader -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 z-50 hidden items-center justify-center backdrop-blur-sm">
        <div class="flex flex-col items-center gap-6">
            <span class="loader"></span>
            <div class="text-center">
                <h4 id="loaderTitle" class="font-bold text-xl text-gray-800">Processing...</h4>
                <p id="loaderText" class="text-sm text-gray-500 mt-1">Please wait a moment</p>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3.5 rounded-2xl shadow-xl text-sm font-medium transition-all duration-300 opacity-0 translate-y-10 z-50 flex items-center gap-3 whitespace-nowrap">
        <span id="toastIcon">‚ú®</span>
        <span id="toastMsg">Action Successful</span>
    </div>

    <!-- Hidden Canvas for Notebook Generation -->
    <canvas id="notebookCanvas" width="800" height="1100"></canvas>

    <script>
        lucide.createIcons();
        const { PDFDocument, rgb, degrees } = PDFLib;
        
        // --- STATE MANAGEMENT ---
        let selectedFiles = {};
        let gridN = 2; 
        let inkColor = 'blue';

        // --- NAVIGATION ---
        function showHome() {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active', 'flex'));
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('screen-home').classList.remove('hidden');
            document.getElementById('screen-home').classList.add('active', 'flex');
            document.getElementById('headerBackBtn').classList.add('hidden');
            resetForms();
        }

        function openTool(toolId) {
            document.getElementById('screen-home').classList.add('hidden');
            document.getElementById('screen-home').classList.remove('active');
            
            const target = document.getElementById(`tool-${toolId}`);
            target.classList.remove('hidden');
            target.classList.add('active', 'flex');
            document.getElementById('headerBackBtn').classList.remove('hidden');
        }

        function resetForms() {
            selectedFiles = {};
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.querySelectorAll('button[id^="btn-"]').forEach(b => b.disabled = true);
            document.querySelectorAll('[id$="List"]').forEach(l => {l.innerHTML=''; l.classList.add('hidden')});
            document.querySelectorAll('[id$="Options"]').forEach(o => {o.classList.remove('flex'); o.classList.add('hidden')});
            document.querySelectorAll('[id$="FileName"]').forEach(t => t.innerText = "Select File");
        }

        // --- FILE HANDLING ---
        function handleFileSelect(type) {
            const inputId = type === 'img2pdf' ? 'img2pdfInput' : (type === 'merge' ? 'mergeInput' : `${type}Input`);
            const input = document.getElementById(inputId);
            const files = Array.from(input.files);
            
            if (!files.length) return;
            selectedFiles[type] = files;
            const btn = document.getElementById(`btn-${type}-action`);

            if (type === 'merge') {
                const list = document.getElementById('mergeFileList');
                list.classList.remove('hidden');
                list.innerHTML = files.map(f => `<div class="bg-gray-50 p-3 rounded-lg flex items-center gap-2 text-xs text-gray-700 border border-gray-100"><i data-lucide="file" class="w-3 h-3 text-red-500"></i> ${f.name}</div>`).join('');
                lucide.createIcons();
            } else if (type === 'img2pdf') {
                const list = document.getElementById('img2pdfList');
                list.classList.remove('hidden');
                list.innerHTML = files.map(f => `<div class="bg-gray-50 p-3 rounded-lg flex items-center gap-2 text-xs text-gray-700 border border-gray-100"><i data-lucide="image" class="w-3 h-3 text-green-500"></i> ${f.name}</div>`).join('');
                lucide.createIcons();
            } else {
                document.getElementById(`${type}FileName`).innerText = files[0].name;
                const opts = document.getElementById(`${type}Options`);
                if(opts) { opts.classList.remove('hidden'); opts.classList.add('flex'); }
            }
            btn.disabled = false;
        }

        // --- UI UTILS ---
        function toggleLoader(show, title="Processing", text="Please wait...") {
            const el = document.getElementById('loadingOverlay');
            document.getElementById('loaderTitle').innerText = title;
            document.getElementById('loaderText').innerText = text;
            el.style.display = show ? 'flex' : 'none';
        }

        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            document.getElementById('toastIcon').innerText = isError ? '‚ùå' : '‚úÖ';
            t.style.opacity = '1';
            t.style.transform = 'translate(-50%, 0)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, 40px)'; }, 3000);
        }

        // --- FEATURE 1: PDF TO NOTEBOOK (The Star Feature) üåü ---
        function setInk(color, btn) {
            inkColor = color;
            document.querySelectorAll('.ink-opt').forEach(b => b.classList.remove('ring-2', 'ring-blue-500'));
            btn.classList.add('ring-2', 'ring-blue-500');
        }

        async function processNotebook() {
            try {
                toggleLoader(true, "Writing Notebook...", "Converting text to handwriting");
                const file = selectedFiles['notebook'][0];
                const arrayBuffer = await file.arrayBuffer();
                
                // 1. Extract Text using PDF.js
                const loadingTask = pdfjsLib.getDocument(arrayBuffer);
                const pdf = await loadingTask.promise;
                let fullText = "";
                
                // Get text from first 5 pages max to avoid crashing browser on huge books
                const maxPages = Math.min(pdf.numPages, 10); 
                for(let i=1; i<=maxPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + "\n\n";
                }

                if(!fullText.trim()) throw new Error("No text found in PDF (scanned?)");

                // 2. Setup Canvas
                const canvas = document.getElementById('notebookCanvas');
                const ctx = canvas.getContext('2d');
                const pdfDoc = await PDFDocument.create();

                // 3. Drawing Configuration
                const lineHeight = 30;
                const margin = 80;
                const startY = 80;
                const maxWidth = canvas.width - margin - 40;
                
                // Helper to draw one page background
                function drawPageBackground() {
                    ctx.fillStyle = "#fffbeb"; // Very light yellow/paper color
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw Lines
                    ctx.strokeStyle = "#94a3b8"; // Light Blue/Gray lines
                    ctx.lineWidth = 1;
                    for(let y = startY; y < canvas.height - 40; y += lineHeight) {
                        ctx.beginPath();
                        ctx.moveTo(0, y);
                        ctx.lineTo(canvas.width, y);
                        ctx.stroke();
                    }
                    
                    // Draw Margin
                    ctx.strokeStyle = "#ef4444"; // Red Margin
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(margin, 0);
                    ctx.lineTo(margin, canvas.height);
                    ctx.stroke();
                }

                // 4. Text Wrapping & Rendering Logic
                ctx.font = "24px 'Patrick Hand', cursive";
                const words = fullText.split(' ');
                let x = margin + 10;
                let y = startY - 5; // Align with line
                
                // Start First Page
                drawPageBackground();
                
                let wordIndex = 0;
                while(wordIndex < words.length) {
                    const word = words[wordIndex];
                    const metrics = ctx.measureText(word + " ");
                    
                    if (x + metrics.width > maxWidth) {
                        x = margin + 10;
                        y += lineHeight;
                        
                        // New Page Check
                        if (y > canvas.height - 50) {
                            // Save current canvas to PDF
                            const imgData = canvas.toDataURL('image/jpeg', 0.8);
                            const imgEmbed = await pdfDoc.embedJpg(imgData);
                            const page = pdfDoc.addPage([canvas.width, canvas.height]);
                            page.drawImage(imgEmbed, { x: 0, y: 0, width: canvas.width, height: canvas.height });
                            
                            // Reset for new page
                            drawPageBackground();
                            y = startY - 5;
                        }
                    }
                    
                    // Ink Color Logic
                    if(inkColor === 'mixed') {
                         const colors = ['#1e3a8a', '#dc2626', '#0f766e', '#000000'];
                         // Randomly change color sometimes or for specific words (simplified: random)
                         ctx.fillStyle = Math.random() > 0.9 ? colors[Math.floor(Math.random() * colors.length)] : '#1e3a8a';
                    } else if (inkColor === 'blue') {
                        ctx.fillStyle = '#1e3a8a'; // Deep Blue Ink
                    } else {
                        ctx.fillStyle = '#1f2937'; // Black Ink
                    }

                    // Slight rotation for handwriting realism
                    ctx.save();
                    ctx.translate(x, y);
                    ctx.rotate((Math.random() - 0.5) * 0.05); // Subtle jitter
                    ctx.fillText(word, 0, 0);
                    ctx.restore();
                    
                    x += metrics.width;
                    wordIndex++;
                }

                // Save final page
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                const imgEmbed = await pdfDoc.embedJpg(imgData);
                const page = pdfDoc.addPage([canvas.width, canvas.height]);
                page.drawImage(imgEmbed, { x: 0, y: 0, width: canvas.width, height: canvas.height });

                const pdfBytes = await pdfDoc.save();
                download(pdfBytes, `notebook-${file.name}`, "application/pdf");
                showToast("Notebook Created! üìí");

            } catch(e) {
                console.error(e);
                showToast(e.message || "Could not read PDF Text", true);
            } finally {
                toggleLoader(false);
            }
        }

        // --- FEATURE 2: PROTECT PDF (Fixed) üîí ---
        async function processProtect() {
            try {
                toggleLoader(true, "Locking PDF...");
                const file = selectedFiles['protect'][0];
                const password = document.getElementById('pdfPassword').value;
                
                if(!password) throw new Error("Please enter a password");

                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFDocument.load(arrayBuffer);
                
                // Explicitly defining encryption details to ensure it works
                const encryptedPdfBytes = await pdfDoc.save({
                    userPassword: password,
                    ownerPassword: password, // Important to set both for simple locking
                    permissions: {
                        printing: 'highResolution',
                        modifying: false,
                        copying: false,
                        annotating: false,
                    },
                });

                download(encryptedPdfBytes, `protected-${file.name}`, "application/pdf");
                showToast("PDF Locked Successfully üîí");
            } catch(e) {
                console.error(e);
                showToast("Protection Failed", true);
            } finally {
                toggleLoader(false);
            }
        }

        // --- FEATURE 3: MERGE ---
        async function processMerge() {
            try {
                toggleLoader(true);
                const files = selectedFiles['merge'];
                const mergedPdf = await PDFDocument.create();
                for (const file of files) {
                    const pdf = await PDFDocument.load(await file.arrayBuffer());
                    const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    pages.forEach(p => mergedPdf.addPage(p));
                }
                download(await mergedPdf.save(), "merged.pdf", "application/pdf");
                showToast("Merged!");
            } catch(e) { showToast("Merge Failed", true); } finally { toggleLoader(false); }
        }

        // --- FEATURE 4: SPLIT ---
        async function processSplit() {
            try {
                toggleLoader(true);
                const file = selectedFiles['split'][0];
                const range = document.getElementById('splitPages').value;
                if(!range) throw new Error("Enter pages");
                
                const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
                const newPdf = await PDFDocument.create();
                const total = pdfDoc.getPageCount();
                let indices = new Set();
                
                range.split(',').forEach(part => {
                    if (part.includes('-')) {
                        const [s, e] = part.split('-').map(Number);
                        if(s && e) for(let i=s; i<=e; i++) indices.add(i-1);
                    } else { const p = Number(part); if(p) indices.add(p-1); }
                });

                const arr = Array.from(indices).filter(i => i>=0 && i<total);
                if(!arr.length) throw new Error("Invalid pages");
                
                (await newPdf.copyPages(pdfDoc, arr)).forEach(p => newPdf.addPage(p));
                download(await newPdf.save(), `split-${file.name}`, "application/pdf");
                showToast("Splitted!");
            } catch(e) { showToast(e.message, true); } finally { toggleLoader(false); }
        }

        // --- FEATURE 5: IMG TO PDF ---
        async function processImgToPdf() {
            try {
                toggleLoader(true);
                const files = selectedFiles['img2pdf'];
                const pdfDoc = await PDFDocument.create();
                for (const file of files) {
                    const buff = await file.arrayBuffer();
                    let img = file.type === 'image/png' ? await pdfDoc.embedPng(buff) : await pdfDoc.embedJpg(buff);
                    const page = pdfDoc.addPage([img.width, img.height]);
                    page.drawImage(img, {x:0, y:0, width:img.width, height:img.height});
                }
                download(await pdfDoc.save(), "images.pdf", "application/pdf");
                showToast("PDF Created!");
            } catch(e) { showToast("Error", true); } finally { toggleLoader(false); }
        }

        // --- FEATURE 6: PDF TO IMAGE ---
        async function processPdfToImg() {
            try {
                toggleLoader(true, "Rendering...");
                const file = selectedFiles['pdf2img'][0];
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                const zip = new JSZip();

                for (let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({scale: 1.5});
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    await page.render({canvasContext: canvas.getContext('2d'), viewport}).promise;
                    zip.file(`page-${i}.jpg`, canvas.toDataURL('image/jpeg', 0.8).split(',')[1], {base64:true});
                }
                download(await zip.generateAsync({type:"blob"}), `${file.name}-images.zip`, "application/zip");
                showToast("Downloaded ZIP!");
            } catch(e) { showToast("Failed", true); } finally { toggleLoader(false); }
        }

        // --- FEATURE 7: COLLAGE ---
        function selectGrid(n, btn) {
            gridN = n;
            document.querySelectorAll('.grid-opt').forEach(b => b.classList.remove('bg-indigo-50', 'text-indigo-700'));
            btn.classList.add('bg-indigo-50', 'text-indigo-700');
        }

        async function processGrid() {
            try {
                toggleLoader(true);
                const file = selectedFiles['grid'][0];
                const srcDoc = await PDFDocument.load(await file.arrayBuffer());
                const destDoc = await PDFDocument.create();
                const count = srcDoc.getPageCount();
                const [W, H] = [595, 842]; // A4
                let currPage;

                for(let i=0; i<count; i++) {
                    const embed = await destDoc.embedPage(srcDoc.getPages()[i]);
                    const dims = embed.scale(1);
                    if(i % gridN === 0) currPage = destDoc.addPage([W, H]);
                    
                    if(gridN === 2) {
                        const scale = Math.min((W-40)/dims.width, (H/2-40)/dims.height);
                        const w = dims.width*scale, h = dims.height*scale;
                        const y = (i%2===0) ? H/2+(H/2-h)/2 : (H/2-h)/2;
                        currPage.drawPage(embed, { x: (W-w)/2, y, width: w, height: h });
                    } else {
                        const scale = Math.min((W/2-30)/dims.width, (H/2-30)/dims.height);
                        const w = dims.width*scale, h = dims.height*scale;
                        const idx = i%4;
                        const cx = (idx%2===0) ? W/4 : W*0.75;
                        const cy = (idx<2) ? H*0.75 : H/4;
                        currPage.drawPage(embed, { x: cx-w/2, y: cy-h/2, width: w, height: h });
                    }
                }
                download(await destDoc.save(), "collage.pdf", "application/pdf");
                showToast("Collage Ready!");
            } catch(e) { showToast("Error", true); } finally { toggleLoader(false); }
        }

    </script>
</body>
</html>



